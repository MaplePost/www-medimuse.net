---
// Display a loaded CSV file
// Uses papa parse

import Icon from "./Icon.astro";
import Divider from "../components/Divider.astro";
---

<div
  id="chart-container"
  class="flex flex-col flex-grow shadow-2xl rounded-2xl overflow-hidden"
>
  <Divider styles="pl-2 pr-2 pt-4 pb-4 md:hidden" />

  <div
    id="chart-controls"
    class="pt-0 md:pt-4 pb-0 md:pb-4 flex flex-row flex-wrap bg-slate-50 border-b"
  >
    <div
      id="chart_hr"
      data-chartFile="HR.csv"
      class="flex cursor-pointer m-1 bg-slate-100 border-r rounded-md shadow-sm overflow-hidden transition-all text-gray-400 hover:text-gray-700"
    >
      <Icon icon="IconHeartRate" class="text-gray-500 ml-1.5 mt-1 w-5 mr-1.5" />
      <p
        class="bg-slate-50 text-xs font-montserrat p-1 pl-1 pr-1.5 select-none"
      >
        Heart-Rate
      </p>
    </div>
    <div
      id="chart_temp"
      data-chartFile="TEMP.csv"
      class="flex cursor-pointer m-1 bg-slate-100 border-r rounded-md shadow-sm overflow-hidden transition-all text-gray-400 hover:text-gray-700"
    >
      <Icon icon="IconTempC" class="text-gray-500 ml-1.5 mt-1 w-5 mr-1.5" />
      <p
        class="bg-slate-50 text-xs font-montserrat p-1 pl-1 pr-1.5 select-none"
      >
        Temperature
      </p>
    </div>
    <div
      id="chart_acc"
      data-chartFile="ACC.csv"
      class="flex cursor-pointer m-1 bg-slate-100 border-r rounded-md shadow-sm overflow-hidden transition-all text-gray-400 hover:text-gray-700"
    >
      <Icon
        icon="IconAccelerometer"
        class="text-gray-500 ml-1.5 mt-1 w-5 mr-1.5"
      />
      <p
        class="bg-slate-50 text-xs font-montserrat p-1 pl-1 pr-1.5 select-none"
      >
        Accelerometer
      </p>
    </div>
    <div
      id="chart_eda"
      data-chartFile="EDA.csv"
      class="flex cursor-pointer m-1 bg-slate-100 border-r rounded-md shadow-sm overflow-hidden transition-all text-gray-400 hover:text-gray-700"
    >
      <Icon icon="IconElectric" class="text-gray-500 ml-1.5 mt-1 w-5 mr-1.5" />
      <p
        class="bg-slate-50 text-xs font-montserrat p-1 pl-1 pr-1.5 select-none"
      >
        Electrodermal
      </p>
    </div>
    <div
      id="chart_bvp"
      data-chartFile="BVP.csv"
      class="flex cursor-pointer m-1 bg-slate-100 border-r rounded-md shadow-sm overflow-hidden transition-all text-gray-400 hover:text-gray-700"
    >
      <Icon icon="IconPulse" class="text-gray-500 ml-1.5 mt-1 w-5 mr-1.5" />
      <p
        class="bg-slate-50 text-xs font-montserrat p-1 pl-1 pr-1.5 select-none"
      >
        Blood Volume Pulse
      </p>
    </div>
    <div
      id="chart_ibi"
      data-chartFile="IBI.csv"
      class="flex cursor-pointer m-1 bg-slate-100 border-r rounded-md shadow-sm overflow-hidden transition-all text-gray-400 hover:text-gray-700"
    >
      <Icon icon="IconInterval" class="text-gray-500 ml-1.5 mt-1 w-5 mr-1.5" />
      <p
        class=" bg-slate-50 text-xs font-montserrat p-1 pl-1 pr-1.5 select-none"
      >
        Inter-Beat Interval
      </p>
    </div>
  </div>
  <div
    id="chart"
    class="relative flex flex-grow justify-center items-center bg-slate-100 p-2"
  >
  </div>
</div>

<script>
  import ApexCharts from "apexcharts";
  import DataLoaders from "./data/LoadersCSV.js";
  import HeartRateChart from "./charts/HeartRate";
  import TemperatureChart from "./charts/Temperature.js";
  import ElectrodermalChart from "./charts/Electrodermal.js";
  import AccelerometerChart from "./charts/Accelerometer.js";
  import BloodVolumePulseChart from "./charts/BloodVolumePulse.js";

  // Variables
  const basePath = "./static/media/csv/";
  const chartContainer = document.querySelector("#chart");
  let loadedData = [];

  // State
  let currentActiveChart = {
    hasChart: null,
    chartModule: null,
    currentControl: null,
  };

  const updateCurrentActiveChart = (
    activeChart = { hasChart: null, chartModule: null, currentControl: null }
  ) => {
    currentActiveChart = activeChart;
  };

  const getCurrentActiveChart = () => {
    return currentActiveChart;
  };

  // List of available samples
  const exampleData_Empatica = [
    {
      name: "rOjO_Ruminate_Pace_15m",
      description: "Empatica smaple recording for playback",
      path: "sample_1/",
      files: [
        "ACC.csv",
        "BVP.csv",
        "EDA.csv",
        "HR.csv",
        "IBI.csv",
        "tags.csv",
        "TEMP.csv",
      ],
    },
  ];

  // Html controls on the page
  const chartControllerObjects = [
    document.getElementById("chart_hr"),
    document.getElementById("chart_temp"),
    document.getElementById("chart_acc"),
    document.getElementById("chart_eda"),
    document.getElementById("chart_bvp"),
  ];

  // Chart render methods
  const renderChart = (options) => {
    let chart = new ApexCharts(chartContainer, options);
    chart.render();
    return chart;
  };

  // attach events
  const chartClickHandler = function (
    chartId = "HR.csv",
    element = document.getElementById("chart_hr")
  ) {
    let chartContainerPointer = null;
    let chart = getCurrentActiveChart();
    let loadResult = null;
    if (chart.currentControl !== null) {
      chart.currentControl.classList.toggle("shadow-lg");
      chart.currentControl.classList.toggle("text-gray-900");
    }
    switch (chartId) {
      case "HR.csv":
        if (chart.hasChart !== null) chart.chartModule.destroy();
        loadResult = loadedData.find(({ name }) => name === "HR.csv");
        chartContainerPointer = renderChart(
          HeartRateChart.getChartData(loadResult.csv.data)
        );
        element.classList.toggle("shadow-lg");
        element.classList.toggle("text-gray-900");
        break;
      case "TEMP.csv":
        if (chart.hasChart !== null) {
          chart.chartModule.destroy();
        }
        loadResult = loadedData.find(({ name }) => name === "TEMP.csv");
        chartContainerPointer = renderChart(
          TemperatureChart.getChartData(loadResult.csv.data)
        );
        element.classList.toggle("shadow-lg");
        element.classList.toggle("text-gray-900");
        break;
      case "ACC.csv":
        if (chart.hasChart !== null) {
          chart.chartModule.destroy();
        }
        loadResult = loadedData.find(({ name }) => name === "ACC.csv");
        chartContainerPointer = renderChart(
          AccelerometerChart.getChartData(loadResult.csv.data)
        );
        element.classList.toggle("shadow-lg");
        element.classList.toggle("text-gray-900");
        break;
      case "EDA.csv":
        if (chart.hasChart !== null) {
          chart.chartModule.destroy();
        }
        loadResult = loadedData.find(({ name }) => name === "EDA.csv");
        chartContainerPointer = renderChart(
          ElectrodermalChart.getChartData(loadResult.csv.data)
        );
        element.classList.toggle("shadow-lg");
        element.classList.toggle("text-gray-900");
        break;
      case "BVP.csv":
        if (chart.hasChart !== null) {
          chart.chartModule.destroy();
        }
        loadResult = loadedData.find(({ name }) => name === "BVP.csv");
        chartContainerPointer = renderChart(
          BloodVolumePulseChart.getChartData(loadResult.csv.data)
        );
        element.classList.toggle("shadow-lg");
        element.classList.toggle("text-gray-900");
        break;
      default:
        updateCurrentActiveChart({
          hasChart: null,
          chartModule: null,
          currentControl: null,
        });
        return;
    }
    updateCurrentActiveChart({
      hasChart: true,
      chartModule: chartContainerPointer,
      currentControl: element,
    });
  };

  // Start - Automatically loads data - Sample 1
  loadedData = await DataLoaders.getEmpaticaData(
    basePath,
    exampleData_Empatica,
    0
  );

  // items loaded setup controller events
  chartControllerObjects.map(function (element, index) {
    element.addEventListener("click", (e) => {
      e.preventDefault();
      let chartFileToLoad = element.getAttribute("data-chartFile");
      chartClickHandler(chartFileToLoad, element);
    });
  });

  // RENDER
  chartClickHandler(); // show default chart on load
</script>
